# 全面审查设计文档（问题清单优先）

- 日期：2026-02-19
- 项目：Aurora MBTI（Next.js）
- 目标：先找后修，先交付全仓深度问题清单，再进入修复阶段

## 1. 审查架构（Architecture）

采用“五层审查架构 + 统一问题模型”，覆盖从基础配置到工程可维护性的全链路风险。

### 五层审查架构

1. Layer 1 基础层
- 依赖、脚本、构建配置、环境变量、部署配置一致性

2. Layer 2 接口层
- `app/api/**` 的鉴权、输入校验、错误码规范、限流、流式协议一致性

3. Layer 3 业务层
- MBTI 计算、题目/结果/档案/历史逻辑正确性与边界条件

4. Layer 4 表现层
- 页面状态流转、可访问性、多语言一致性、异常态体验

5. Layer 5 工程层
- 可维护性（重复代码、模块边界、类型安全）、测试缺口

### 统一问题模型

每条问题统一包含以下字段：
- 严重级别：`P0/P1/P2/P3`
- 定位：文件路径 + 行号
- 证据：触发条件、复现步骤或代码依据
- 影响：用户、安全、稳定性、维护成本
- 修复建议：最小改动优先

## 2. 组件与交付物（Components）

本轮仅输出审查结果，不改动业务代码。交付以下 4 项：

1. 主问题清单（必交）
- 内容：全仓问题，按 `P0 -> P3` 排序
- 结构：问题描述 / 位置 / 证据 / 影响 / 建议
- 目标：可直接转 issue 与修复任务

2. 风险矩阵（必交）
- 维度：发生概率 × 影响范围
- 目标：辅助确定修复优先级

3. 修复批次建议（必交）
- Batch 1：阻断上线问题
- Batch 2：稳定性问题
- Batch 3：体验与维护性问题
- 每批次附改动面评估（小/中/大）

4. 回归测试建议（必交）
- 为每个 `P0/P1` 提供最小回归用例
- 标注手测或自动化优先级

## 3. 审查数据流与执行顺序（Data Flow）

### 固定执行顺序

1. 静态扫描
- 目录、配置、路由、关键库与共享模块关系

2. 接口走查
- 逐个 API 核验输入、鉴权、异常、输出契约

3. 业务走查
- MBTI 核心计算与状态存储一致性

4. 页面走查
- 关键页面状态机（加载、成功、失败、空态）与 i18n 对齐

5. 交叉验证
- 文档声明与实际实现对齐（`README.md`、`docs/API.md`、代码）

6. 归档评级
- 统一转为 `P0-P3` 问题清单并去重

### 证据采集规则

- 每条问题至少有一条可验证证据
- 无证据不进入主清单
- 不确定项标注“待确认”，单独归档

## 4. 错误处理与审查边界（Error Handling）

### 审查边界

1. 本轮不改代码，仅输出问题与修复建议
2. 无法稳定复现的项标注为“潜在风险”并附复现条件
3. 不改 CI、部署环境和密钥配置，仅输出风险建议

### 错误处理核查重点

1. 接口类
- 状态码是否与 `docs/API.md` 对齐
- 错误结构是否统一（`success/version/error`）
- 流式接口是否具备中断与异常回传机制

2. 安全类
- 鉴权绕过路径
- 输入校验缺失导致的注入与滥用风险
- 敏感信息暴露（日志、响应、调试接口）

3. 前端类
- 异步失败的 UI 兜底是否完整
- 多语言 key 缺失与错配
- 客户端存储与真实状态一致性

### 输出分组规则

- 确定缺陷：有明确证据与可复现路径
- 潜在风险：当前证据不足但风险成立条件清晰

## 5. 测试策略与验收标准（Testing & Acceptance）

### 审查阶段测试策略

1. 静态验证：`typecheck/build` 级别问题与类型风险
2. 契约验证：API 请求/响应与文档一致性
3. 关键链路验证：测试页 -> 结果页 -> AI 生成 -> 历史/档案 -> 后台
4. 安全验证：鉴权、限流、输入校验、调试开关暴露
5. 一致性验证：中英日文案、错误消息与行为一致

### 交付验收标准

1. 提供可执行的 `P0-P3` 问题清单（带文件定位）
2. 每个 `P0/P1` 提供复现条件或触发路径
3. 每个问题提供最小修复建议
4. 提供修复批次与优先级建议
5. 明确未覆盖项和外部依赖验证项（如需要真实 API Key 的验证点）

## 6. 后续衔接

- 当前阶段：已完成审查设计确认
- 下一阶段：进入 writing-plans，产出详细执行计划，再启动实际深度审查
